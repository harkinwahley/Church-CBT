<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE WAY OF GOD BIBLE MINISTRY - Sunday School Exam</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        :root{
            --prime-txt:#2c3e50; --btn-green:#4CAF50; --btn-green-h:#45a049; --bg-grad-s:#ffecd2; --bg-grad-e:#fcb69f;
            --card-bg:#fff; --brdr-clr:#ddd; --timer-clr:#e74c3c; --txt-light:#fff;
        }

        body{
            font-family:'Comic Neue',cursive;margin:0;padding:0;
            background:linear-gradient(to right,var(--bg-grad-s),var(--bg-grad-e));
            color:var(--prime-txt);text-align:center;
            display:flex;justify-content:center;align-items:center;
            min-height:100vh;font-size:18px;line-height:1.5;
        }

        .container{
            background-color:var(--card-bg);border-radius:15px;
            box-shadow:0 8px 20px rgba(0,0,0,.15);padding:30px;
            width:90%;max-width:600px;box-sizing:border-box;
            margin:20px auto;
        }

        h1{
            font-family:'Comic Neue',cursive;color:var(--btn-green);
            font-size:2.8em;margin-bottom:20px;text-shadow:1px 1px 3px rgba(0,0,0,.08);
        }

        h2{
            color:var(--prime-txt);font-size:2.2em;margin-bottom:25px;
        }

        p{
            margin-bottom:15px;
        }

        .input-group label{
            display:block;margin-bottom:8px;font-weight:bold;
        }

        .input-group input[type="text"]{
            width:calc(100% - 24px);padding:12px;
            margin-bottom:20px;border:1px solid var(--brdr-clr);
            border-radius:8px;font-size:1em;box-sizing:border-box;
        }

        .question-container{
            border:1px solid var(--brdr-clr);border-radius:10px;
            padding:25px;margin-bottom:20px;background-color:#f9f9f9;
            text-align:left;
        }

        .question-text{
            font-size:1.4em;margin-bottom:15px;font-weight:bold;
            color:var(--prime-txt);
        }

        .options-list{
            list-style:none;padding:0;margin:0;
        }

        .options-list li{
            margin-bottom:10px;
        }

        .options-list label{
            display:flex;align-items:center;cursor:pointer;
            font-size:1.1em;
        }

        .options-list input[type="radio"]{
            margin-right:10px;transform:scale(1.2);
        }

        .timer-bar{
            background-color:#eee;border-radius:5px;
            height:15px;margin-bottom:20px;overflow:hidden;
        }

        .timer-fill{
            height:100%;background-color:var(--timer-clr);
            width:100%;transition:width .5s linear;
        }

        .timer-display{
            font-size:1.5em;font-weight:bold;color:var(--timer-clr);
            margin-bottom:20px;
        }

        .navigation-buttons button{
            background-color:var(--btn-green);color:var(--txt-light);
            padding:12px 25px;border:none;border-radius:25px;
            font-size:1em;cursor:pointer;transition:background-color .3s,transform .2s;
            font-weight:bold;box-shadow:0 4px 10px rgba(0,0,0,.1);
            margin:0 10px;
        }

        .navigation-buttons button:hover{
            background-color:var(--btn-green-h);transform:translateY(-2px);
            box-shadow:0 6px 12px rgba(0,0,0,.15);
        }

        .navigation-buttons button:disabled{
            background-color:#ccc;cursor:not-allowed;box-shadow:none;
            transform:none;
        }

        .final-score{
            font-size:2.5em;font-weight:bold;color:var(--btn-green);
            margin-top:20px;
        }

        #result-details p{
            font-size:1.2em;margin-bottom:10px;
        }

        #start-exam-btn{
            background-color:var(--btn-green);color:var(--txt-light);
            padding:18px 35px;border:none;border-radius:30px;
            font-size:1.2em;cursor:pointer;transition:background-color .3s,transform .2s;
            font-weight:bold;box-shadow:0 5px 15px rgba(0,0,0,.15);
        }

        #start-exam-btn:hover{
            background-color:var(--btn-green-h);transform:translateY(-3px);
            box-shadow:0 8px 18px rgba(0,0,0,.2);
        }

        /* Basic modal for confirmation */
        .custom-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .modal-buttons button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 20px;
            box-shadow: none; /* Remove extra shadow for modal buttons */
        }

        .modal-buttons button.cancel {
            background-color: #ccc;
            color: var(--prime-txt);
        }
        .modal-buttons button.cancel:hover {
            background-color: #bbb;
            transform: none;
        }

        @media (max-width: 600px) {
            .container { padding: 20px; margin: 10px auto; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.8em; }
            .question-text { font-size: 1.2em; }
            .options-list label { font-size: 1em; }
            .navigation-buttons button { padding: 10px 15px; font-size: 0.9em; margin: 0 5px; }
            #start-exam-btn { padding: 15px 25px; font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <div class="container" id="welcomePage">
        <h1>THE WAY OF GOD BIBLE MINISTRY</h1>
        <h2>Sunday School Exam</h2>
        <p>Welcome, dear student! This exam is designed to test your understanding of our Sunday School lessons. Please enter your name to begin.</p>
        <div class="input-group">
            <label for="userNameInput">Your Name:</label>
            <input type="text" id="userNameInput" placeholder="Enter your name" required>
        </div>
        <button id="start-exam-btn">Start Exam</button>
    </div>

    <div class="container" id="examPage" style="display:none;">
        <div class="timer-display" id="timer-display">Time Left: 15:00</div>
        <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>

        <div class="question-container">
            <div class="question-text" id="question-text"></div>
            <ul class="options-list" id="options-list">
                </ul>
        </div>

        <div class="navigation-buttons">
            <button id="prev-btn">Previous</button>
            <button id="next-btn">Next</button>
            <button id="submit-btn">Submit Exam</button>
        </div>
    </div>

    <div class="container" id="resultPage" style="display:none;">
        <h1>Exam Completed!</h1>
        <p>Thank you for taking the exam, <span id="display-user-name"></span>!</p>
        <p class="final-score">Your Score: <span id="final-score"></span></p>
        <div id="result-details">
            <p>Percentage: <span id="display-percentage"></span></p>
            <p>Missed Questions: <span id="display-missed-questions"></span></p>
            </div>
    </div>

    <div id="confirmModal" class="custom-modal">
        <div class="modal-content">
            <p id="modalMessage">Are you sure you want to submit the exam?</p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn">Yes, Submit</button>
                <button id="modalCancelBtn" class="cancel">No, Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Configuration ---
      const firebaseConfig = {
  apiKey: "AIzaSyBcAU4wF6scW2wmBmDn2BbE8Lf_jbXsCrU",
  authDomain: "sunday-cbt.firebaseapp.com",
  projectId: "sunday-cbt",
  storageBucket: "sunday-cbt.firebasestorage.app",
  messagingSenderId: "1081445319494",
  appId: "1:1081445319494:web:8149a46380b55ae85c5b47"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Get Firestore instance
        // --- End Firebase Configuration ---


        // DOM Elements
        const DOM = {
            welcomePage: document.getElementById('welcomePage'),
            examPage: document.getElementById('examPage'),
            resultPage: document.getElementById('resultPage'),
            userNameInput: document.getElementById('userNameInput'),
            startExamBtn: document.getElementById('start-exam-btn'),
            timerDisplay: document.getElementById('timer-display'),
            timerFill: document.getElementById('timer-fill'),
            questionText: document.getElementById('question-text'),
            optionsList: document.getElementById('options-list'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            submitBtn: document.getElementById('submit-btn'),
            displayUserName: document.getElementById('display-user-name'),
            finalScore: document.getElementById('final-score'),
            displayPercentage: document.getElementById('display-percentage'),
            displayMissedQuestions: document.getElementById('display-missed-questions'),
            confirmModal: document.getElementById('confirmModal'),
            modalMessage: document.getElementById('modalMessage'),
            modalConfirmBtn: document.getElementById('modalConfirmBtn'),
            modalCancelBtn: document.getElementById('modalCancelBtn')
        };

        // Exam Data
        const QUESTIONS = [
            {
                question: "Who founded THE WAY OF GOD BIBLE MINISTRY?",
                options: ["A. Pastor T.B. Joshua", "B. Prophet Samson Olanrewaju", "C. Pastor E.A. Adeboye", "D. Bishop David Oyedepo"],
                correct: "B. Prophet Samson Olanrewaju"
            },
            {
                question: "What is the primary focus of THE WAY OF GOD BIBLE MINISTRY?",
                options: ["A. Prosperity teachings", "B. Evangelism and discipleship", "C. Social activism", "D. Political engagement"],
                correct: "B. Evangelism and discipleship"
            },
            {
                question: "Which book of the Bible is primarily focused on the law?",
                options: ["A. Genesis", "B. Exodus", "C. Leviticus", "D. Numbers"],
                correct: "C. Leviticus"
            },
            {
                question: "Who was the first king of Israel?",
                options: ["A. David", "B. Solomon", "C. Saul", "D. Samuel"],
                correct: "C. Saul"
            },
            {
                question: "Which disciple betrayed Jesus?",
                options: ["A. Peter", "B. Judas Iscariot", "C. John", "D. Thomas"],
                correct: "B. Judas Iscariot"
            },
            {
                question: "What is the longest book in the Bible?",
                options: ["A. Isaiah", "B. Psalms", "C. Jeremiah", "D. Ezekiel"],
                correct: "B. Psalms"
            },
            {
                question: "Who built the ark before the great flood?",
                options: ["A. Moses", "B. Abraham", "C. Noah", "D. Jacob"],
                correct: "C. Noah"
            },
            {
                question: "In which city was Jesus born?",
                options: ["A. Nazareth", "B. Jerusalem", "C. Bethlehem", "D. Galilee"],
                correct: "C. Bethlehem"
            },
            {
                question: "What is the last book of the New Testament?",
                options: ["A. Romans", "B. Revelation", "C. Matthew", "D. Acts"],
                correct: "B. Revelation"
            },
            {
                question: "How many days and nights did Jesus fast in the desert?",
                options: ["A. 7 days and 7 nights", "B. 20 days and 20 nights", "C. 40 days and 40 nights", "D. 3 days and 3 nights"],
                correct: "C. 40 days and 40 nights"
            }
        ];

        // Dynamically create CORRECT_ANSWERS object from QUESTIONS array
        const CORRECT_ANSWERS = {};
        QUESTIONS.forEach((q, index) => {
            CORRECT_ANSWERS[index + 1] = q.correct;
        });

        let currentQuestionIndex = 0;
        let answers = {};
        let userName = '';
        let timer;
        const EXAM_DURATION_SECONDS = 15 * 60; // 15 minutes
        let timeRemaining = EXAM_DURATION_SECONDS;
        const totalQuestions = QUESTIONS.length;
        let generatedId = ''; // To store the unique ID for this exam session


        // --- Custom Modal Functions ---
        let pendingAction = null; // Stores the function to be executed on confirmation

        function showModal(message, onConfirm) {
            DOM.modalMessage.textContent = message;
            pendingAction = onConfirm;
            DOM.confirmModal.style.display = 'block';
        }

        function hideModal() {
            DOM.confirmModal.style.display = 'none';
            pendingAction = null;
        }

        DOM.modalConfirmBtn.addEventListener('click', () => {
            if (pendingAction) {
                pendingAction();
            }
            hideModal();
        });

        DOM.modalCancelBtn.addEventListener('click', hideModal);

        // --- Exam Flow Functions ---

        // Generate a simple unique ID for the exam
        function generateUniqueId() {
            return 'exam_' + Date.now() + Math.floor(Math.random() * 1000);
        }

        // Start Exam Function
        DOM.startExamBtn.addEventListener('click', () => {
            userName = DOM.userNameInput.value.trim();
            if (userName) {
                generatedId = generateUniqueId(); // Generate ID when exam starts
                DOM.welcomePage.style.display = 'none';
                DOM.examPage.style.display = 'block';
                displayQuestion(currentQuestionIndex);
                startTimer();
            } else {
                alert('Please enter your name to start the exam.');
            }
        });

        // Display Question
        function displayQuestion(index) {
            currentQuestionIndex = index;
            const question = QUESTIONS[index];
            DOM.questionText.textContent = `${index + 1}. ${question.question}`;

            DOM.optionsList.innerHTML = '';
            question.options.forEach(option => {
                const li = document.createElement('li');
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'question' + (index + 1);
                radio.value = option;
                radio.id = `q${index + 1}-option-${option.charAt(0)}`;
                radio.checked = (answers[index + 1] === option); // Retain selection

                const label = document.createElement('label');
                label.htmlFor = `q${index + 1}-option-${option.charAt(0)}`;
                label.textContent = option;

                li.appendChild(radio);
                li.appendChild(label);
                DOM.optionsList.appendChild(li);
            });

            updateNavigationButtons();
        }

        // Timer Functions
        function startTimer() {
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                updateTimerBar();
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    alert('Time is up! Submitting your exam.');
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            DOM.timerDisplay.textContent = `Time Left: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateTimerBar() {
            const percentage = (timeRemaining / EXAM_DURATION_SECONDS) * 100;
            DOM.timerFill.style.width = percentage + '%';
        }

        // Navigation Buttons
        DOM.nextBtn.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex < totalQuestions - 1) {
                displayQuestion(currentQuestionIndex + 1);
            }
        });

        DOM.prevBtn.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex > 0) {
                displayQuestion(currentQuestionIndex - 1);
            }
        });

        DOM.submitBtn.addEventListener('click', () => {
            saveCurrentAnswer();
            confirmSubmit(); // Use custom modal for confirmation
        });

        // Update Button States
        function updateNavigationButtons() {
            DOM.prevBtn.disabled = currentQuestionIndex === 0;
            DOM.nextBtn.disabled = currentQuestionIndex === totalQuestions - 1;
            DOM.submitBtn.style.display = (currentQuestionIndex === totalQuestions - 1) ? 'inline-block' : 'none';
        }

        // Save Answer
        function saveCurrentAnswer() {
            const qNum = currentQuestionIndex + 1;
            const selectedOption = document.querySelector(`input[name="question${qNum}"]:checked`);
            if (selectedOption) {
                answers[qNum] = selectedOption.value;
            }
        }

        // Confirm Submission - Now uses custom modal
        function confirmSubmit() {
            showModal('Are you sure you want to submit the exam?', submitExam);
        }

        // Submit Exam
        function submitExam() {
            clearInterval(timer); // Stop the timer

            const score = calculateScore();

            DOM.examPage.style.display = 'none';
            DOM.resultPage.style.display = 'block';

            const examResult = {
                name: userName,
                examId: generatedId,
                timestamp: new Date().toLocaleString(),
                score: score,
                totalQuestions: totalQuestions,
                percentage: ((score / totalQuestions) * 100).toFixed(2) + '%',
                answers: answers,
                correctAnswers: CORRECT_ANSWERS // Uses the global constant
            };

            storeExamResult(examResult);

            // Display results on the page
            DOM.displayUserName.textContent = userName;
            DOM.finalScore.textContent = `${score}/${totalQuestions}`;
            DOM.displayPercentage.textContent = examResult.percentage;

            let missedQNums = [];
            for (let i = 1; i <= totalQuestions; i++) {
                if (answers[i] !== CORRECT_ANSWERS[i]) {
                    missedQNums.push(i);
                }
            }
            if (missedQNums.length > 0) {
                DOM.displayMissedQuestions.textContent = missedQNums.join(', ');
                DOM.displayMissedQuestions.style.color = 'red';
                DOM.displayMissedQuestions.style.fontWeight = 'bold';
            } else {
                DOM.displayMissedQuestions.textContent = 'None';
                DOM.displayMissedQuestions.style.color = 'green';
            }
        }

        // Score Calculation Function
        function calculateScore() {
            let score = 0;
            for (let i = 1; i <= totalQuestions; i++) {
                if (answers[i] === CORRECT_ANSWERS[i]) { // Uses the global constant
                    score++;
                }
            }
            return score;
        }

        // Function to send results to Firestore
        async function storeExamResult(result) {
            try {
                // Add a new document to the 'examResults' collection
                const docRef = await db.collection('examResults').add(result);
                console.log("Exam result saved to Firestore with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding document to Firestore: ", e);
                alert("Failed to save exam results. Please try again or contact support.");
            }
        }
    </script>
</body>
</html>