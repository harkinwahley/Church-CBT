<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Exam Results</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables - Consistent with your main site */
        :root{
            --prime-txt:#2c3e50; /* Dark blue */
            --btn-green:#4CAF50; /* Green */
            --btn-green-h:#45a049; /* Darker green */
            --bg-grad-s:#ffecd2; /* Peach start */
            --bg-grad-e:#fcb69f; /* Pinkish end */
            --card-bg:#fff;      /* White */
            --brdr-clr:#ddd;     /* Light grey */
            --timer-clr:#e74c3c; /* Red */
            --txt-light:#fff;    /* White text */
        }

        body {
            font-family: 'Comic Neue', cursive;
            margin: 0; padding: 20px;
            background: linear-gradient(to right, var(--bg-grad-s), var(--bg-grad-e));
            color: var(--prime-txt);
            display: flex; justify-content: center; align-items: flex-start; /* Align to top */
            min-height: 100vh;
            font-size: 18px; line-height: 1.5;
        }

        .container {
            background-color: var(--card-bg); border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,.15); padding: 30px;
            width: 100%; max-width: 900px; /* Wider for table */
            box-sizing: border-box; margin: 20px auto; /* Centered with margin */
            text-align: center;
        }

        h1 {
            font-family: 'Comic Neue', cursive;
            color: var(--btn-green); font-size: 2.8em;
            margin-bottom: 30px; text-shadow: 1px 1px 3px rgba(0,0,0,.08);
        }

        table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
            font-size: 1.05em;
        }

        th, td {
            border: 1px solid var(--brdr-clr); padding: 12px; text-align: left;
        }

        th {
            background-color: var(--btn-green); color: var(--txt-light);
            font-weight: bold;
        }

        tbody tr:nth-child(even) {
            background-color: #f0fff0; /* Light green for even rows */
        }
        tbody tr:hover {
            background-color: #e6ffe6; /* Lighter green on hover */
        }

        button {
            display: inline-block; background-color: var(--btn-green);
            color: var(--txt-light); padding: 14px 28px; margin: 15px auto 0;
            border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer;
            transition: background-color .3s,transform .2s;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,.1);
        }

        button:hover {
            background-color: var(--btn-green-h); transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,.15);
        }

        /* Styles for Login Form */
        #login-container {
            max-width: 400px;
            padding: 40px;
            text-align: left;
        }

        #login-container h2 {
            font-size: 2.2em;
            color: var(--prime-txt);
            margin-bottom: 25px;
            text-align: center;
        }

        #login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--prime-txt);
        }

        #login-form input[type="email"],
        #login-form input[type="password"] {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--brdr-clr);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
        }

        #login-error-message {
            color: var(--timer-clr);
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* Basic modal for confirmation instead of browser confirm() */
        .custom-modal {
            display: none; /* Hidden by default */
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.4); /* Dark overlay */
        }

        .modal-content {
            background-color: var(--card-bg); margin: 15% auto; padding: 20px;
            border: 1px solid #888; border-radius: 10px;
            width: 80%; max-width: 400px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .modal-buttons button {
            margin: 10px; padding: 10px 20px;
            font-size: 1em; border-radius: 20px;
            box-shadow: none; /* Remove extra shadow for modal buttons */
        }

        .modal-buttons button.cancel {
            background-color: #ccc; color: var(--prime-txt);
        }
        .modal-buttons button.cancel:hover {
            background-color: #bbb; transform: none;
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 20px; margin: 10px auto; }
            h1 { font-size: 2em; }
            th, td { padding: 8px; font-size: 0.9em; }
            button { padding: 10px 20px; font-size: 1em; }
            #login-container { padding: 30px; }
            #login-container h2 { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="container" id="login-container">
        <h2>Admin Login</h2>
        <form id="login-form">
            <label for="email">Email:</label>
            <input type="email" id="email" required>

            <label for="password">Password:</label>
            <input type="password" id="password" required>

            <button type="submit" id="login-btn">Login</button>
            <p id="login-error-message" style="display:none;"></p>
        </form>
    </div>

    <div class="container" id="admin-panel" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Exam Results Admin Panel</h1>
            <button id="logout-btn" style="margin: 0; padding: 10px 20px; font-size: 0.9em;">Logout</button>
        </div>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Exam Name</th>
                    <th>Score</th>
                    <th>Percentage</th>
                    <th>Missed Questions</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button id="clearResultsBtn">Clear All Results</button>
    </div>

    <div id="confirmModal" class="custom-modal">
        <div class="modal-content">
            <p id="modalMessage">Are you sure you want to clear all exam results? This cannot be undone.</p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn">Yes, Clear</button>
                <button id="modalCancelBtn" class="cancel">No, Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase project configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
        apiKey: "AIzaSyBcAU4wF6scW2wmBmDn2BbE8Lf_jbXsCrU",
        authDomain: "sunday-cbt.firebaseapp.com",
        projectId: "sunday-cbt",
        storageBucket: "sunday-cbt.firebasestorage.app",
        messagingSenderId: "1081445319494",
        appId: "1:1081445319494:web:8149a46380b55ae85c5b47"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Get Auth instance
        const db = firebase.firestore(); // Get Firestore instance

        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginErrorMessage = document.getElementById('login-error-message');
            const logoutBtn = document.getElementById('logout-btn');

            const resultsTableBody = document.querySelector('#resultsTable tbody');
            const clearResultsBtn = document.getElementById('clearResultsBtn');
            const confirmModal = document.getElementById('confirmModal');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            let pendingAction = null;

            // --- Modal Functions ---
            function showModal(message, onConfirm) {
                document.getElementById('modalMessage').textContent = message;
                pendingAction = onConfirm;
                confirmModal.style.display = 'block';
            }

            function hideModal() {
                confirmModal.style.display = 'none';
                pendingAction = null;
            }

            modalConfirmBtn.addEventListener('click', () => {
                if (pendingAction) {
                    pendingAction();
                }
                hideModal();
            });

            modalCancelBtn.addEventListener('click', hideModal);

            // --- Authentication Logic ---

            // Handle login form submission
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent default form submission
                const email = emailInput.value;
                const password = passwordInput.value;

                loginErrorMessage.style.display = 'none'; // Hide previous errors

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    // User successfully signed in, onAuthStateChanged will handle UI
                } catch (error) {
                    console.error("Login Error:", error.code, error.message);
                    let errorMessage = "Login failed. Please check your credentials.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = "Invalid email or password.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email format.";
                    }
                    loginErrorMessage.textContent = errorMessage;
                    loginErrorMessage.style.display = 'block';
                }
            });

            // Handle logout button click
            logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log("User logged out.");
                    // UI will be updated by onAuthStateChanged
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert("Error logging out. Please try again.");
                }
            });

            // Listen for authentication state changes
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    loginContainer.style.display = 'none';
                    adminPanel.style.display = 'block';
                    loadResults(); // Load results only when user is logged in
                } else {
                    // User is signed out
                    adminPanel.style.display = 'none';
                    loginContainer.style.display = 'block';
                    emailInput.value = ''; // Clear form fields
                    passwordInput.value = '';
                    loginErrorMessage.style.display = 'none'; // Clear error message
                    resultsTableBody.innerHTML = ''; // Clear results table
                }
            });

            // --- Firestore Data Functions ---

            // Function to load results from Firestore
            async function loadResults() {
                resultsTableBody.innerHTML = ''; // Clear previous results
                try {
                    const querySnapshot = await db.collection('examResults').orderBy('timestamp', 'desc').get();
                    const results = [];
                    querySnapshot.forEach(doc => {
                        results.push({ id: doc.id, ...doc.data() });
                    });

                    if (results.length === 0) {
                        const row = resultsTableBody.insertRow();
                        row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px;">No exam results found.</td>';
                        return;
                    }

                    results.forEach(result => {
                        const row = resultsTableBody.insertRow();
                        row.insertCell().textContent = result.name;
                        row.insertCell().textContent = result.examName || 'Sunday School Exam';
                        row.insertCell().textContent = `${result.score}/${result.totalQuestions}`;
                        row.insertCell().textContent = result.percentage;

                        const missedQuestionsCell = row.insertCell();
                        let missedQNums = [];
                        if (result.correctAnswers && result.answers) {
                            for (let i = 1; i <= result.totalQuestions; i++) {
                                const qNumStr = String(i);
                                if (result.answers[qNumStr] !== result.correctAnswers[qNumStr]) {
                                    missedQNums.push(i);
                                }
                            }
                        }

                        if (missedQNums.length > 0) {
                            missedQuestionsCell.textContent = missedQNums.join(', ');
                            missedQuestionsCell.style.color = 'red';
                            missedQuestionsCell.style.fontWeight = 'bold';
                        } else {
                            missedQuestionsCell.textContent = 'None';
                            missedQuestionsCell.style.color = 'green';
                        }
                        row.insertCell().textContent = result.timestamp;
                    });
                } catch (error) {
                    console.error("Error loading results from Firestore: ", error);
                    const row = resultsTableBody.insertRow();
                    row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: red;">Error loading results. Please check console.</td>';
                }
            }

            // Function to clear all results from Firestore
            async function clearAllResults() {
                try {
                    const querySnapshot = await db.collection('examResults').get();
                    const batch = db.batch();
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log("All results cleared from Firestore.");
                    loadResults(); // Reload to show empty state
                } catch (error) {
                    console.error("Error clearing results from Firestore: ", error);
                    alert("Failed to clear results. Please check console for details.");
                }
            }

            // Event listener for clear results button
            clearResultsBtn.addEventListener('click', () => {
                // Ensure user is logged in before showing confirmation
                if (auth.currentUser) {
                    showModal('Are you sure you want to clear all exam results? This cannot be undone.', clearAllResults);
                } else {
                    alert("You must be logged in to clear results.");
                }
            });
        });
    </script>
</body>
</html>